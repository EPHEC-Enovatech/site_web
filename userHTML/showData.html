<div id="dataBox">
    <h1>Le potager graphique</h1>
    <hr>
    <div id="selectZone">
        <p>Vous avez acquis un Sensory Captor ? Selectionner le dans la liste ci dessous et commencez l'aventure !</p>
        <br>
        <label for="selectBox">Sensory Captor :</label>
        <select id="selectBox" name="selectBox">

        </select>
    </div>
    <hr>
    <div id="showDataBox">

        <span id="errorData"></span>

        <div id="canvasHumiditeDemo">
            <span id="errorHumiditeDemo"></span>
            <canvas id="humiditeDemo"></canvas>
        </div>

        <div id="canvas2">
            <canvas id="myChart2"></canvas>
        </div>

        <div id="canvas3">
            <canvas id="myChart3"></canvas>
        </div>
    </div>
</div>
<script>
    callAPI("devices/1", selectData);

    //Rempli le seclect de box dans showData
    function selectData(response){

        let select = "<option value=\"noData\">Selectionner un Sensory Captor</option>";
        select += "<option value=" + response.data.device_id + ">";
        select += response.data.deviceName + "</option>";
        $('#selectBox').html(select);

        $('#selectBox').on('change', function(){
            var selectedCaptor = $('#selectBox').val();
            console.log(selectedCaptor);

            if(selectedCaptor === "noData"){
                $('#errorData').text("Veuillez sélectionner un Sensory Captor");
                $('#canvasHumiditeDemo').hide();
                let chartHumiditeDemo = new Chart(document.getElementById('humiditeDemo').getContext('2d'), 0);
            } else {
                $('#errorData').text("");
                let endPoint = "/records/" + selectedCaptor + "/humidite/18-10-2018";
                callAPI(endPoint, buildHumiditeDemo);

                let today = buildDateAPI(moment(new Date()).format("L"));
                let previousWeekDay = buildDateAPI(moment(new Date(today)).subtract(7, 'days').format("L"));

                let endPoint2 = "/records/" + selectedCaptor + "/humidite/" + previousWeekDay + "/" + today;
                callAPI(endPoint2, buildAverageHumiditeDemo);
            }
        });
    }

    //Construit le graphique de démo de l'humidité
    function buildHumiditeDemo(response){

        $('#canvasHumiditeDemo').show();

        var humidData = [];

        var humidDate = [];

        var data = response.data;

        data.forEach(function(item){
            let date = moment(new Date(item.timestamp)).format('LTS');
            humidDate.push(date);
        });

        data.forEach(function(item){
            humidData.push(item.data);
        });

        let dateJour = moment(response.data[0].timestamp).format('LL');

        var ctx = document.getElementById('humiditeDemo').getContext('2d');
        var chartHumiditeDemo = new Chart(ctx, {
            // The type of chart we want to create
            type: 'line',

            // The data for our dataset
            data: {
                labels: humidDate,
                datasets: [{
                    label: "Humidité du sol le " + dateJour,
                    backgroundColor: 'rgb(255, 99, 132)',
                    borderColor: 'rgb(255, 99, 132)',
                    data: humidData,
                }]
            },

            // Configuration options go here
            options: {
                title: {
                    text: "Taux d'humidité dans le sol"
                },
            }
        });
    }

    function buildAverageHumiditeDemo(response){
        let weekDay = [];
        let dataWeekDay = [];

        
    }

    //Renvoie la date dans la bonne forme pour l'API
    function buildDateAPI(date){
        return date.replace(/\//g, '-');
    }
</script>